@page "/software"
@model Asharea_viewer.Pages.dashboard.softwareModel
@{ ViewData["Title"] = "Software"; }

@section sideInfo {
    <!-- Side info -->
    <div class="card mb-4">
        <div class="card-body text-center">
            <img src="assets/img/avatars/profile_default.jpg" alt="" class="ui-w-80 rounded-circle mt-2 mb-3 user-image">
            <h5 class="mb-2 u_full_name"></h5>
            <div class="text-muted small"></div>
            @*<button class="btn-outline-primary btn btn-round mt-3 edit_profile_btn"><i class="fas fa-user-edit"></i> Edit Profile</button>*@
            @*<button class="btn-outline-primary btn btn-round mt-3" id="reset_password_btn"><i class="fas fa-key"></i> Reset Password</button>*@

        </div>
        <hr class="border-light m-0">
        <div class="card-body">
            <h5 class="mb-4 font-weight-bold text-dark">
                Contact Information
            </h5>
            <div class="mb-2">
                <span class="text-muted">Email Address:</span>
                <div class="mt-2 font-weight-bold text-dark u_email"></div>
            </div>

            <div class="mb-2">
                <span class="text-muted">Phone</span>
                <div class="font-weight-bold text-dark mt-2 u_phone"></div>
            </div>

            <div class="mb-2">
                <span class="text-muted">Organization</span>
                <div class="font-weight-bold text-dark mt-2 u_organization"></div>
            </div>
        </div>
        @*<hr class="border-light m-0">
        <div class="card-body">
            <div class='mb-4'>
            </div>
        </div>*@
    </div>
    <!-- / Side info -->
}

@section navArchor {
    <h4 class="font-weight-bold py-3 mb-4">
        <a class="text-muted" href="/software">Dashboard</a>
    </h4>
}
<!-- / Info -->
<div class="nav-tabs-top nav-responsive-sm">
    <ul class="nav nav-tabs nav-justified tabs-alt" id="tab-text">
       
    </ul>
    <div class="tab-content">
        <div class="tab-pane fade show active" id="software">
            <div class="card mb-4">
                <h5 class="card-header with-elements">
                    <div class="card-header-title">Software (<span id="software_cnt">0</span>)</div>
                    <div class="card-header-elements ml-auto">
                        <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#add-software-model">
                            <i class="ion ion-md-add"></i> Add
                        </button>
                    </div>
                </h5>
                <div class="card-body" id="software_list">
                    
              
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="events">
            <div class="card-body">
                <h5 class="mb-4 font-weight-bold">
                    Event (6)
                </h5>
                <div class="row">
                    <div class="col col-sm-6 col-lg-4">
                        <div class="card">
                            <div class="card-body">

                                <div class="text-center">
                                    <h6>Ashrae gbXML Webniar</h6>
                                </div>
                                <hr class="d-lg-none w-100 my-2">
                                <small class="text-danger text-left py-3 d-block font-weight-bold">Sun, July 19,2020 1:15 PM PDT</small>
                                <div class="text-center">
                                    <h6>Ashrae gbXML Webniar</h6>
                                    <h6>Validator Education 101</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col col-sm-6 col-lg-4">
                        <div class="card">
                            <div class="card-body">

                                <div class="text-center">
                                    <h6>Ashrae gbXML Webniar</h6>
                                </div>
                                <hr class="d-lg-none w-100 my-2">
                                <small class="text-danger text-left py-3 d-block font-weight-bold">Sun, July 19,2020 1:15 PM PDT</small>
                                <div class="text-center">
                                    <h6>Ashrae gbXML Webniar</h6>
                                    <h6>Validator Education 101</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col col-sm-6 col-lg-4">
                        <div class="card">
                            <div class="card-body">

                                <div class="text-center">
                                    <h6>Ashrae gbXML Webniar</h6>
                                </div>
                                <hr class="d-lg-none w-100 my-2">
                                <small class="text-danger text-left py-3 d-block font-weight-bold">Sun, July 19,2020 1:15 PM PDT</small>
                                <div class="text-center">
                                    <h6>Ashrae gbXML Webniar</h6>
                                    <h6>Validator Education 101</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="messages">
            <div class="card-body">
                <h5 class="mb-4 font-weight-bold">
                    Messages (5)
                </h5>
                <div class="media pb-1 mb-3">
                    <img src="assets/img/avatars/6-small.png" class="d-block ui-w-40 rounded-circle" alt>
                    <div class="media-body ml-3">
                        <div class="mb-1">
                            <strong class="font-weight-semibold">Mae Gibson</strong> &nbsp;
                            <small class="text-muted float-right">58m ago</small>
                        </div>
                        <a href="javascript:void(0)" class="text-body">Sit meis deleniti eu, pri vidit meliore docendi ut.</a>
                    </div>
                </div>
                <div class="media pb-1 mb-3">
                    <img src="assets/img/avatars/4-small.png" class="d-block ui-w-40 rounded-circle" alt>
                    <div class="media-body ml-3">
                        <div class="mb-1">
                            <strong class="font-weight-semibold">Kenneth Frazier</strong> &nbsp;
                            <small class="text-muted float-right">1h ago</small>
                        </div>
                        <a href="javascript:void(0)" class="text-body">Mea et legere fuisset, ius amet purto luptatum te.</a>
                    </div>
                </div>
                <div class="media pb-1 mb-3">
                    <img src="assets/img/avatars/5-small.png" class="d-block ui-w-40 rounded-circle" alt>
                    <div class="media-body ml-3">
                        <div class="mb-1">
                            <strong class="font-weight-semibold">Nelle Maxwell</strong> &nbsp;
                            <small class="text-muted float-right">2h ago</small>
                        </div>
                        <a href="javascript:void(0)" class="text-body">Sit meis deleniti eu, pri vidit meliore docendi ut.</a>
                    </div>
                </div>
                <div class="media">
                    <img src="assets/img/avatars/1-small.png" class="d-block ui-w-40 rounded-circle" alt>
                    <div class="media-body ml-3">
                        <div class="mb-1">
                            <strong class="font-weight-semibold">Mike Greene</strong> &nbsp;
                            <small class="text-muted float-right">1d ago</small>
                        </div>
                        <a href="javascript:void(0)" class="text-body">Lorem ipsum dolor sit amet, vis erat denique in.</a>
                    </div>
                </div>
                <a href="javascript:void(0)" class="card-footer d-block text-center text-body small font-weight-semibold mt-3">SHOW MORE</a>
            </div>
        </div>
        <div class="tab-pane fade" id="documents">
            <div class="file-manager-container file-manager-row-view mt-3 mb-3">

                <div class="file-manager-row-header row">
                    <div class="file-item-name pb-2 col-4">Filename</div>
                    <div class="file-item-owner pb-2 col-3">Owner</div>
                    <div class="file-item-size pb-2 col-2">Size</div>
                    <div class="file-item-changed pb-2 col">Date modified</div>
                </div>

                <div class="file-item">
                    <div class="file-item-icon file-item-level-up fas fa-level-up-alt text-secondary"></div>
                    <a href="javascript:void(0)" class="file-item-name">
                        ..
                    </a>
                </div>

                <div class="file-item row">

                    <div class="file-item-icon far fa-folder text-secondary"></div>
                    <a href="javascript:void(0)" class="file-item-name col-4">
                        Images
                    </a>
                    <div class="file-item-owner col-3">Rosa</div>
                    <div class="file-item-size col-2">1.2Mb</div>
                    <div class="file-item-changed col">02/13/2018</div>

                </div>

                <div class="file-item row">

                    <div class="file-item-icon far fa-folder text-secondary"></div>
                    <a href="javascript:void(0)" class="file-item-name col-4">
                        Scripts
                    </a>
                    <div class="file-item-owner col-3">David</div>
                    <div class="file-item-size col-2">1.2Mb</div>
                    <div class="file-item-changed col">02/15/2018</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal template -->
<div class="modal fade" id="update-software-model">
    <div class="modal-dialog">
        <form class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Software
                    <span class="font-weight-light">Information</span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="ui-w-65 software-icon" style="padding: 10px" id="update-software-image">
                        <img src="~/imgs/icons/gbxml_icon.png" alt="" />
                    </div>
                    <div style="margin: auto 10px;">
                        <input type="file" id="software-image-upload" hidden accept="image/*" />
                        <label for="software-image-upload" class="btn btn-primary btn-sm">Select Image</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col mb-0">
                        <label class="form-label">Software name*</label>
                        <input type="text" class="form-control" id="new_sw_name" placeholder="Autodesk Autocad">
                    </div>
                    <div class="form-group col mb-0">
                        <label class="form-label">Version*</label>
                        <input type="text" class="form-control" id="new_sw_version" placeholder="Version 2">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="new_sw_desc" placeholder="...">
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="update_software_btn">Update</button>
            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="edit-profile-model">
    <div class="modal-dialog">
        <form class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Profile
                    <span class="font-weight-light">Information</span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="ui-w-65" style="padding: 10px">
                        <img src="assets/img/avatars/profile_default.jpg" alt="" class="ui-w-80 rounded-circle mt-2 mb-3 user-image"/>
                    </div>
                    <div style="margin: auto 10px;">
                        <input type="file" id="profile-upload" hidden accept="image/*"/>
                        <label for="profile-upload" class="btn btn-primary btn-sm">Select Image</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col mb-0">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control" id="mem_first_name">
                    </div>
                    <div class="form-group col mb-0">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="mem_last_name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col">
                        <label class="form-label">Organization</label>
                        <input type="text" class="form-control" id="mem_organization" placeholder="...">
                    </div>
                    <div class="form-group col">
                        <label class="form-label">phone</label>
                        <input type="text" class="form-control" id="mem_phone">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="update_profile_btn">Update</button>
            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="reset-password-model">
    <div class="modal-dialog">
        <form class="modal-content" method="post" id="validation-form" novalidate="novalidate" class="my-5">
            <div class="modal-header">
                <h5 class="modal-title">
                    Reset
                    <span class="font-weight-light">Password</span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Old Password *</label>
                    <input type="password" class="form-control reuqired is_invalid" id="old_password" name="old_password">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" class="form-control reuqired is_invalid" id="password" name="password">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password *</label>
                    <input type="password" class="form-control required is_invalid" id="confirm" name="confirm">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onClick="validatePassword(event);">Change password</button>

            </div>
        </form>
    </div>
</div>
<div class="modal fade" id="add-software-model">
    <div class="modal-dialog">
        <form class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Software
                    <span class="font-weight-light">Information</span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="ui-w-65 software-icon" style="padding: 10px">
                        <img src="~/imgs/icons/gbxml_icon.png" alt="" id="add-software-image"/>
                    </div>
                    <div style="margin: auto 10px;">
                        <input type="file" id="software-image-add" hidden accept="image/*" />
                        <label for="software-image-add" class="btn btn-primary btn-sm">Select Image</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col mb-0">
                        <label class="form-label">Software name*</label>
                        <input type="text" class="form-control" id="sw_name" placeholder="Autodesk Autocad">
                    </div>
                    <div class="form-group col mb-0">
                        <label class="form-label">Version*</label>
                        <input type="text" class="form-control" id="sw_version" placeholder="Version 2">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="sw_desc" placeholder="...">
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save_software_btn">Save</button>
            </div>
        </form>
    </div>
</div>
<template id="new_software_row">
    <div class="pb-1 mb-3 row software_item">
        <div class="col-2 software-icon">
            <img class="ui-w-65" src="~/imgs/icons/gbxml_icon.png" alt="">
        </div>
        <div class="col">
            <div class="float-right icon-size btn">
                <i class="ion ion-md-create ml-3 edit_icon_btn"></i>
            </div>
            <a href="javascript:void(0)" class="font-weight-bold text-dark new_sw_name">Autodesk Revit</a>
            <span class="text-muted ml-3 new_sw_date">03/25/2020</span>
            <br>
            <small class="text-muted">Description: <span class="new_sw_desc"></span></small>
            <br>
            <small class="text-muted">Certification Level: <span class="new_sw_level">Lv2</span>  <span class="font-weight-bold text-primary ml-5 btn new_sw_status btn p-0">Start</span> </small>
        </div>
    </div>
</template>
<script>
    $(function () {
        let total_software = 0;
        let selected_id;
        get_software().then(function (data) {
            total_software = data.length;
            $("#software_cnt").html(total_software);
            $.each(data, function (_, item) {
                $("#software_list").html();
                add_new_software_item(item);
            });
        });
        $.validator.addMethod("pwcheck", function (value, element) {
            return /[a-z]/.test(value) // has a lowercase letter
                && /\d/.test(value) // has a digit
        }, "At least one lowercase letter and one number digit");

        $.validator.addMethod("notEqual", function (value, element, param) {
            return this.optional(element) || value != $(param).val();
        }, "Your new password cannot be same as old password.");

        $(".new_sw_status").click(function () {
            let id = $(this).attr("id");
            localStorage.setItem("software_id", id);
            window.location = '/certification';
        })
        $(document).ready(function () {
            $("#software_list").on('click', '.new_sw_status', function () {
                let id = $(this).attr("id");
                localStorage.setItem("software_id", id);
                window.location = '/certification';
            });
            $("#software_list").on('click', '.edit_icon_btn', function () {
                let id = $(this).attr("id");
                selected_id = id;
                get_one_software(id).then(function (data) {
                    $("#new_sw_name").val(data['name']);
                    $("#new_sw_desc").val(data['description']);
                    $("#new_sw_version").val(data['version']);
                    $("#update_software_btn").attr("sw_id", id);
                    $("#update-software-model").modal('toggle');
                })
                
            });
        });
        $("#reset_password_btn").click(function () {
            $("#reset-password-model").modal('toggle');
        })
        $("#update_software_btn").click(function () {
            console.log("update software");
            let id = $(this).attr("sw_id");
            let name = $("#new_sw_name").val();
            let version = $("#new_sw_version").val();
            let desc = $("#new_sw_desc").val();
            
            update_software(id, name, desc, version).then(function (data) {
                console.log(data);
                $(".software_item[id='" + id + "']").find(".new_sw_name").html(name);
                $(".software_item[id='" + id + "']").find(".new_sw_desc").html(desc);
                $(".software_item[id='" + id + "']").find(".new_sw_version").html(version);
                $("#update-software-model").modal('toggle');
            })
        });
        $(".edit_profile_btn").click(function () {
            get_user_info().then(function (data) {
                $("#mem_first_name").val(data['firstName']);
                $("#mem_last_name").val(data['lastName']);
                $("#mem_organization").val(data['organization']);
                $("#mem_phone").val(data['phone']);
            });
            $("#edit-profile-model").modal('toggle');
        });
        $("#update_profile_btn").click(function () {
            let first_name = $("#mem_first_name").val();
            let last_name = $("#mem_last_name").val();
            let organization = $("#mem_organization").val();
            let phone = $("#mem_phone").val();
            update_user_info(first_name, last_name, organization, phone).then(function (data) {
                $(".u_full_name").html(data["fullname"]);
                $(".u_email").html(data['email'] ? data['email'] : "N/A");
                $(".u_organization").html(data['organization'] ? data['organization'] : "N/A");
                $(".u_phone").html(data['phone'] ? data['phone'] : "N/A");
                $("#edit-profile-model").modal('toggle');
            })
        })
        $("#profile-upload").on('change', function () {
            let input = this;
            if (input.files && input.files[0]) {
                update_profile_image(input.files[0]).then(function (data) {
                    $('.user-image').attr('src', data);
                })
            }
        });
        $("#software-image-upload").on('change', function () {
            let input = this;
            if (input.files && input.files[0]) {
                update_software_image(selected_id, input.files[0]).then(function (data) {
                    $("#update-software-image img").attr("src", data);
                    $(".software_item[id='" + selected_id + "'] img").attr('src', data);
                })
            }
        });
        let selected_file;
        $("#software-image-add").on('change', function () {
            let input = this;
            if (input.files && input.files[0]) {
                selected_file = input.files[0];
                get_cropped_image(input.files[0]).then(function (data) {
                    $('#add-software-image').attr('src', data);
                })
            }
        })
        $("#save_software_btn").click(function () {
            console.log("save software");
            let name = $("#sw_name").val();
            let version = $("#sw_version").val();
            let desc = $("#sw_desc").val();
            add_software(name, desc, version).then(function (data) {
                if (selected_file) {
                    update_software_image(data['id'], selected_file).then(function (image_src) {
                        data['picUrl'] = image_src;
                        add_new_software_item(data);
                        $("#add-software-model").modal('toggle');
                    })
                } else {
                    add_new_software_item(data);
                    $("#add-software-model").modal('toggle');
                }
                
                total_software += 1;
                $("#software_cnt").html(total_software);
                
            })
        });

    });
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#add-software-image').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]); // convert to base64 string
        }
    }
    function add_new_software_item(item) {
        let holder = $(document.getElementById("new_software_row").content.cloneNode(true));
        holder.find(".new_sw_name").html(item['name'] + " " + item['version']);
        holder.find(".new_sw_date").html(moment(item['createdDate']).format('MM/DD/YYYY'));
        holder.find(".new_sw_desc").html(item['description']);
        holder.find(".new_sw_level").html(item['certificationLevel'] ? item['certificationLevel'] : "N/A");
        holder.find(".new_sw_status").html(item['status']).attr("id", item['id']);
        holder.find(".edit_icon_btn").attr("id", item['id']);
        holder.find(".software_item").attr("id", item['id']);
        if (item['picUrl']) {
            holder.find(".software-icon img").attr("src", item['picUrl']);
        }
        
        $("#software_list").append(holder);
    }
    function validatePassword(e) {
        e.preventDefault();


        var validator = $("#validation-form").validate({
            errorPlacement: function (error, element) {
                var $parent = $(element).parents('.form-group');
                $parent.append(
                    error.addClass('jquery-validation-error small form-text invalid-feedback')
                );
            },
            rules: {

                old_password: {
                    notEqual: "#password"
                },
                confirm: {
                    equalTo: "#password"
                },
                password: {
                    required: true,
                    pwcheck: true,
                    minlength: 5
                }
            },
            message: {
                password: {
                    pwcheck: "Your password must contain at least one lowercase letter and one number digit",
                    minlength: "Your password must be at least 5 characters long"
                }
            }
        });
        if (validator.form()) {
            let password = $("#confirm").val();
            let old_password = $('#old_password').val();
            let url = window.location.href;
            let uuid = url.split("?")[1];
            $.ajax({
                type: 'POST',
                url: get_root_Api() + 'api/UpdatePassword',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', get_token());
                },
                data: {
                    oldPassword: old_password,
                    password: password
                },
                success: function (data) {
                    pop_info_go("Notice", "Password has been updated!\nPlease login again", "./login");
                },
                error: function (error) {
                    $("#password").val("");
                    $("#confirm").val("");
                    console.log(error);
                    pop_info("Error", "Reset password failed.");
                }
            });
        }
    }

</script>